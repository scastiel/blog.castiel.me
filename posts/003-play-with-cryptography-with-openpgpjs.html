<!DOCTYPE html><html><head><title>Play with cryptography with OpenPGP.js – Another webdev blog</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="https://blog.castiel.me/css/app.css"><link rel="alternate" type="application/rss+xml" title="Another webdev blog" href="https://blog.castiel.me/rss.xml"></head><body><header class="blog-header"><h1 class="blog-title"><a href="https://blog.castiel.me/">Another webdev blog</a></h1><div class="blog-description"><p>I&#39;m <a href="https://twitter.com/scastiel">Sébastien Castiel</a>, and I talk about web development and some other stuff.</p>
</div></header><article><header><h2><a href="https://blog.castiel.me/posts/003-play-with-cryptography-with-openpgpjs.html">Play with cryptography with OpenPGP.js</a></h2><div class="infos"><time datetime="2016-11-16T19:33:12.000Z">Nov 16, 2016</time></div></header><div class="content"><p>For about a year now, I use <a href="https://protonmail.com">ProtonMail</a> as my mail provider. If you don&#39;t know it, you should definitively give it a look! The mails are encrypted <em>end-to-end</em>, which means that ProtonMail has absolutely no readable version of the stored emails, nor any key to decrypt them.</p>
<p>But one thing ProtonMail doesn&#39;t do is giving the ability to export emails, for example if you want to make back-ups, or move to another provider. That&#39;s why I developed <a href="https://github.com/scastiel/protonmail-export">a tool to give you this ability</a>; and to develop this tool I used a fantastic library: <a href="https://openpgpjs.org/">OpenPGP.js</a>, which is by the way maintained by ProtonMail ;)</p>
<p>If you know asymetric cryptography principles, I&#39;ll just show how OpenPGP.js provides a very easy way to play with private and public key generation, and of course encrypting/decrypting and signing/verifying messages. If you don&#39;t, this article may also be the opportunity to discover it with very simple examples.</p>
<!--readmore-->
<h2 id="generate-keys">Generate keys</h2>
<p>Let&#39;s start with the basics! If you want to send or receive encrypted data to someone, the first thing you&#39;ll need is a key. And more precisely a pair of a public key and a private key. The private key will be used to decrypt data (only you have it, it&#39;s very secret), and the public key will be used to encrypt the data (you must send it to your friends so they can send you encrypted data).</p>
<p>The easiest way to put this in practice is to open two terminal windows in the same directory. From one of them, run the commands <code>npm init -y</code> and <code>npm install openpgp</code>. Then from both windows, start Node prompt with command <code>node</code>, and import the module with <code>var openpgp = require(&#39;openpgp&#39;)</code>. In the following examples, we&#39;ll imagine that each prompt represents a person (let&#39;s call them Alice and Bob), and the two persons want to send encrypted data to each other.</p>
<p>So, let&#39;s generate our keys! From Alice&#39;s prompt, run the following:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> options = {
    <span class="hljs-attr">userIds</span>: [{ <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">'alice@example.com'</span> }],
    <span class="hljs-attr">numBits</span>: <span class="hljs-number">2048</span>,
    <span class="hljs-attr">passphrase</span>: <span class="hljs-string">'secret'</span>
};
<span class="hljs-keyword">var</span> pubKey, privKey;
openpgp.generateKey(options).then(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
    privKey = key.privateKeyArmored;
    pubKey = key.publicKeyArmored;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Key generated'</span>);
});
</code></pre>
<p>The message “Keys generated” may take a few seconds to come; key generation can be a quite long process. If you run <code>console.log(pubKey); console.log(privKey)</code>, you should see the two keys (in base-64), beginning respectively with “-----BEGIN PGP PUBLIC KEY BLOCK-----” and “-----BEGIN PGP PRIVATE KEY BLOCK-----”.</p>
<h2 id="encrypt-a-message">Encrypt a message</h2>
<p>As I said, the public key can be sent to everyone to encrypt data that only Alice will be able to decrypt. So let&#39;s copy Alice&#39;s public key into a variable in Bob&#39;s prompt:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> alicePublicKey = <span class="hljs-string">`-----BEGIN PGP PUBLIC KEY BLOCK-----(...)`</span>;
</code></pre>
<p><em>Note that we use backquotes instead of simple or double quote, because it allows to write strings on multiple lines.</em></p>
<p>Now that he has her public key, Bob wants to send a secret message to Alice. So let&#39;s do it:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> options = {
    <span class="hljs-attr">data</span>: <span class="hljs-string">'This is a very secret message'</span>,
    <span class="hljs-attr">publicKeys</span>: openpgp.key.readArmored(alicePublicKey).keys
};
openpgp.encrypt(options).then(<span class="hljs-function"><span class="hljs-params">encryptedData</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(encryptedData.data);
});
</code></pre>
<p>You should see the encrypted message, beginning with ”-----BEGIN PGP MESSAGE-----”. That&#39;s the data Bob can now send to Alice!</p>
<p>Let&#39;s copy this message into Alice&#39;s prompt:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> bobEncryptedMessage = <span class="hljs-string">`-----BEGIN PGP MESSAGE-----(...)`</span>;
</code></pre>
<h2 id="decrypt-the-message">Decrypt the message</h2>
<p>To decrypt Bob&#39;s message, all Alice needs is her private key. But before she can use it, she must unlock it with here passphrase.</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> key = openpgp.key.readArmored(privKey).keys[<span class="hljs-number">0</span>];
key.decrypt(<span class="hljs-string">'secret'</span>);
<span class="hljs-keyword">var</span> options = {
    <span class="hljs-attr">message</span>: openpgp.message.readArmored(bobEncryptedMessage),
    <span class="hljs-attr">privateKey</span>: key
};
openpgp.decrypt(options).then(<span class="hljs-function"><span class="hljs-params">decryptedMessage</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(decryptedMessage.data);
});
</code></pre>
<p>The original message appears :)</p>
<h2 id="sign-a-message">Sign a message</h2>
<p>In our previous example, Bob sends an encrypted message to Alice that only her can decrypt. But Alice cannot be sure that the message comes from Bob, since she sent her public key to all of her friends. That&#39;s why assymetric cryptography gives a second very useful feature: signing data.</p>
<p>The principle is almost the same than encrypting data, but to sign his message, Bob will use his own private key, and to verify that the message comes from Bob, Alice will use Bob&#39;s public key.</p>
<p>First let&#39;s generate public and private key for Bob: (in Bob&#39;s prompt, so)</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> options = {
    <span class="hljs-attr">userIds</span>: [{ <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">'bob@example.com'</span> }],
    <span class="hljs-attr">numBits</span>: <span class="hljs-number">2048</span>,
    <span class="hljs-attr">passphrase</span>: <span class="hljs-string">'secret'</span>
};
<span class="hljs-keyword">var</span> pubKey, privKey;
openpgp.generateKey(options).then(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
    privKey = key.privateKeyArmored;
    pubKey = key.publicKeyArmored;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Key generated'</span>);
});
</code></pre>
<p>Next let&#39;s ”send” Bob&#39;s public key to Alice by running <code>console.log(pubKey);</code> in Bob&#39;s prompt, and copying-pasting the result into Alice&#39;s:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> bobPublicKey = <span class="hljs-string">`-----BEGIN PGP PUBLIC KEY BLOCK-----(...)`</span>;
</code></pre>
<p>Next, in Bob&#39;s prompt, let&#39;s encrypt our message again, but this time we&#39;ll also sign it. To do this, we just add a private key to the encrypting process.</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> key = openpgp.key.readArmored(privKey).keys[<span class="hljs-number">0</span>];
key.decrypt(<span class="hljs-string">'secret'</span>);
<span class="hljs-keyword">var</span> options = {
    <span class="hljs-attr">data</span>: <span class="hljs-string">'This is a very secret and signed message'</span>,
    <span class="hljs-attr">publicKeys</span>: openpgp.key.readArmored(alicePublicKey).keys,
    <span class="hljs-attr">privateKeys</span>: [key]
};
openpgp.encrypt(options).then(<span class="hljs-function"><span class="hljs-params">encryptedData</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(encryptedData.data);
});
</code></pre>
<p>Again, let&#39;s copy the resulting encrypted and signed message into Alice&#39;s prompt:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> bobEncryptedAnsSignedMessage = <span class="hljs-string">`-----BEGIN PGP MESSAGE-----(...)`</span>;
</code></pre>
<h2 id="verify-the-signed-message">Verify the signed message</h2>
<p>To sign the message we added a private key to the encrypting process; well to verify the signature we&#39;ll just add Bob&#39;s public key to the decrypting process:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> key = openpgp.key.readArmored(privKey).keys[<span class="hljs-number">0</span>];
key.decrypt(<span class="hljs-string">'secret'</span>);
<span class="hljs-keyword">var</span> options = {
    <span class="hljs-attr">message</span>: openpgp.message.readArmored(bobEncryptedAnsSignedMessage),
    <span class="hljs-attr">publicKeys</span>: openpgp.key.readArmored(bobPublicKey).keys,
    <span class="hljs-attr">privateKey</span>: key
};
openpgp.decrypt(options).then(<span class="hljs-function"><span class="hljs-params">decryptedMessage</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(decryptedMessage.data);
    <span class="hljs-built_in">console</span>.log(decryptedMessage.signatures[<span class="hljs-number">0</span>].valid);
});
</code></pre>
<p>As a result you can still see the decrypted message, but also that the signature associated with the message is valid regarding Bob&#39;s public key! No possible doubt, the message was encrypted by Bob :)</p>
<hr>
<p>This is it for this brief introduction to cryptography using OpenPGP.js! If you were already familiar with OpenPGP, I hope this article convinced you that using in JavaScript is very easy; if you were not, I hope it made you want to know more about it and maybe use it in your own applications.</p>
<p>Just a last thing: OpenPGP.js can be used with Node.js (as we saw it), but also directly client-side in the browser :D</p>
<p>Resources:</p>
<ul>
<li><a href="https://github.com/openpgpjs/openpgpjs">OpenPGP.js&#39;s Github</a>, with some examples</li>
<li><a href="https://protonmail.com/blog/openpgpjs-email-encryption/">ProtonMail now the maintainer of OpenPGPjs email encryption library</a> on ProtonMail&#39;s blog</li>
</ul>
</div></article><div id="disqus_thread"></div><script>var disqus_config = function () {
    this.page.url = 'https://blog.castiel.me/posts/003-play-with-cryptography-with-openpgpjs';  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = '003-play-with-cryptography-with-openpgpjs'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//blog-castiel-me.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();</script><footer class="blog-footer"><p>All content distributed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license. Powered by <a href="https://github.com/scastiel/miblog">Miblog</a>.</p>
</footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-86441091-1', 'auto');
ga('send', 'pageview');</script></body></html>